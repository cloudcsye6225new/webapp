name: Ami_Test_Creation

on:
  push:
    branches: ["main"]

jobs:
  build:
    name: pr-check
    runs-on: ubuntu-latest

    env:
      PGHOST: ${{ secrets.PGHOST }}
      PGPORT: ${{ secrets.PGPORT }}
      PGUSER: postgres
      PGPASSWORD: ${{ secrets.PGPASSWORD }}
      PGDATABASE: ${{ secrets.PGDATABASE }}
      TEST_DATABASE: ${{ secrets.TEST_DATABASE }}
      Region: ${{secrets.REGION}}
      NEW_AMI_ID: "" # This will store the new AMI ID created by Packer

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
      - name: Start PostgreSQL service
        run: sudo service postgresql start

      - name: Wait for PostgreSQL to start
        run: |
          timeout 5 bash -c '
            until sudo -u postgres psql -c "\\l" &>/dev/null; do
             sleep 1
           done
          '
      - name: Check PostgreSQL status
        run: sudo service postgresql status

      - name: Create PostgreSQL user and database
        run: |
          echo "ALTER USER postgres WITH ENCRYPTED PASSWORD '${{ secrets.PGPASSWORD }}';" | sudo -u postgres psql
      - name: Create PostgreSQL database
        run: |
          psql -h localhost -U postgres -d postgres -c "CREATE DATABASE ${{ secrets.PGDATABASE }};"
          psql -h localhost -U postgres -d postgres -c "CREATE DATABASE ${{ secrets.TEST_DATABASE }};"
      - name: List PostgreSQL databases
        run: |
          psql -h localhost -U postgres -l
      - name: Install Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.x" # Replace with your desired Python version

      - name: changing directory
        run: |
          pwd
          ls
          cd App_Test
          ls
          pip install -r requirements.txt

      - name: install psycopg2
        run: |
          sudo apt install libpq-dev
          pip install psycopg2-binary
          # Install uvicorn
          pip install uvicorn

      - name: Run FastAPI application
        run: |
          pwd
          cd App_Test
          uvicorn main:app --host 0.0.0.0 --port 8000 --reload &

      - name: Wait for FastAPI to start
        run: |
          cd App_Test
          pytest

      - name: Create .env file
        run: |
          echo "DATABASE_NAME=${{ secrets.DATABASE_NAME }}" >> .env
          echo "PGDATABASE=${{ secrets.PGDATABASE }}" >> .env
          echo "PGHOST=${{ secrets.PGHOST }}" >> .env
          echo "PGPASSWORD=${{ secrets.PGPASSWORD }}" >> .env
          echo "PGPORT=${{ secrets.PGPORT }}" >> .env
          echo "TEST_DATABASE=${{ secrets.TEST_DATABASE }}" >> .env

      - name: List Files
        run: ls -al

      - name: Create Zip File
        run: |
          zip -r webapp.zip .

      - name: Upload Zip File
        uses: actions/upload-artifact@v3
        with:
          name: webapp zip creation
          path: webapp.zip

      - name: Moving Zip to APP_TEST
        run: |
          ls
          pwd
          sudo mv /home/runner/work/webapp/webapp/webapp.zip /home/runner/work/webapp/webapp/App_Test/

      - name: Run Packer
        run: |
          # Install Packer
          curl -fsSL https://releases.hashicorp.com/packer/1.7.3/packer_1.7.3_linux_amd64.zip -o packer.zip
          unzip packer.zip
          sudo mv packer /usr/local/bin/
          ls
          pwd
          cd App_Test
          packer init packer-webapp.pkr.hcl

          packer build -var "aws_access_key=${{ secrets.AWS_ACCESS_KEY }}" \
             -var "aws_secret_access_key=${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
             -var "aws_region=${{ secrets.AWS_REGION }}" \
             -var "ami_name_prefix=${{ secrets.AMI_NAME_PREFIX }}" \
             -var "source_ami=${{ secrets.SOURCE_AMI }}" \
             -var "instance_type=${{ secrets.INSTANCE_TYPE }}" \
             -var "ssh_username=${{ secrets.SSH_USERNAME }}" \
             packer-webapp.pkr.hcl

      - name: Extract AMI ID from Manifest
        run: |
          AMI_ID=$(jq -r '.builds[0].artifact_id' App_Test/ami-output.txt | cut -d':' -f2)
          echo "NEW_AMI_ID=$AMI_ID" >> $GITHUB_ENV
          echo "Extracted AMI ID: $AMI_ID"

      - name: Update Launch Template with New AMI
        run: |
              # Create a new launch template version with the updated AMI
                  VERSION_NUMBER=$(aws ec2 create-launch-template-version \
                      --launch-template-name "webapp-launch-template" \
                      --launch-template-data "{\"ImageId\":\"$NEW_AMI_ID\", \"InstanceType\":\"t2.micro\"}" \
                      --query "LaunchTemplateVersion.VersionNumber" \
                      --output text)

                  if [ -z "$VERSION_NUMBER" ]; then
                    echo "Error: Failed to retrieve the new Launch Template version number."
                    exit 1
                  fi
              
                  echo "New Launch Template Version: $VERSION_NUMBER"
              
                  # Set the newly created version as the default
                  aws ec2 modify-launch-template \
                    --launch-template-name "webapp-launch-template" \
                    --default-version "$VERSION_NUMBER"
              
                  echo "Successfully set the default Launch Template version to: $VERSION_NUMBER"

      - name: Start Instance Refresh
        run: |
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "custom_autoscaling_group" \
            --preferences '{"MinHealthyPercentage": 100}' \
            --query "InstanceRefreshId" --output text)
          echo "Instance Refresh ID: $REFRESH_ID"

      - name: Monitor Instance Refresh
        run: |
         # Monitor the status of the refresh
          while true; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name "${{ secrets.ASG_NAME }}" \
              --query "InstanceRefreshes[?InstanceRefreshId=='$REFRESH_ID'].Status" \
              --output text)

            echo "Current refresh status: $STATUS"

            if [[ "$STATUS" == "Successful" ]]; then
              echo "Instance refresh completed successfully."
              break
            elif [[ "$STATUS" == "Failed" || "$STATUS" == "Cancelled" ]]; then
              echo "Instance refresh failed or was cancelled."
              exit 1
            else
              echo "Instance refresh in progress. Checking again in 30 seconds..."
              sleep 30
            fi
          done
